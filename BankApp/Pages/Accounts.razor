@page "/accounts"
@inject IAccountService AccountService

@*
	Page that displays all user bank accounts.
	Displays automatic interest updates for saving accounts.
	Displays an error if something fails and allows deleting accounts.
*@

<h3>Dina Konton</h3>

<p class="text-muted mb-2">
	Ränta beräknas automatiskt på alla sparkonton varje minut.
</p>
@if (!string.IsNullOrEmpty(_interestBanner))
{
	<div class="alert alert-info py-2 my-2">
		@_interestBanner
	</div>
}
@if (!string.IsNullOrWhiteSpace(_error))
{
	<div class="alert alert-danger">@_error</div>
}

@* If there are no accounts, show an empty-state message. *@
@if (!accounts.Any())
{
	<p>Inga konton skapade ännu.</p>
}
else
{
	@* Accounts table: name, type, currency, balance, last updated, and actions. *@
	<table class="table table-striped align-middle">
		<thead>
			<tr>
				<th>Namn</th>
				<th>Typ</th>
				<th>Valuta</th>
				<th class="text-end">Saldo</th>
				<th>Senast uppdaterad</th>
				<th class="text-end">Åtgärd</th>
			</tr>
		</thead>
		<tbody>
			@* Show one table row for each account. *@
			@foreach (var acc in accounts)
			{
		       <tr>
				   <td>@acc.Name</td>
				   <td>@acc.AccountType</td>
				   <td>@acc.Currency</td>
				   <td class="text-end">@acc.Balance.ToString("N0", CultureInfo.GetCultureInfo("sv-SE"))</td>
				   <td>@acc.LastUpdated.ToString("yyyy-MM-dd HH:mm", CultureInfo.GetCultureInfo("sv-SE"))</td>
				   <td class="text-end">
					   @* Delete the selected account, then refresh the list. *@
					   <button class="btn btn-sm btn-outline-danger me-2"
						       @onclick="() => DeleteAccount(acc.Id)">
						   Radera
					   </button>
					</td>
				</tr>
			}
		</tbody>
	</table>
}

@* Handles loading and deleting bank accounts. *@
@code {
	private string? _error;
	private string? _interestBanner;

	// Contains all accounts currently displayed in the table.
	private List<IBankAccount> accounts = new();

	// Deletes an account by its ID and refreshes the account list.
	private async Task DeleteAccount(Guid id)
	{
		_error = null;
		try
		{
			await AccountService.DeleteAccountAsync(id);
			accounts = await AccountService.GetAccountsAsync();
		}
		catch (Exception ex)
		{
			_error = ex.Message;
		}
	}

	// Loads all accounts when the page is first initialized.
	protected override async Task OnInitializedAsync()
	{
		accounts = await AccountService.GetAccountsAsync();

		AccountService.InterestApplied += OnInterestApplied;
	}

	// Handles the event when interest is applied and updates the UI with a temporary banner.
	private async void OnInterestApplied(object? sender, InterestAppliedEventArgs e)
	{
		try
		{
			accounts = await AccountService.GetAccountsAsync();

			var name = accounts.FirstOrDefault(a => a.Id == e.AccountId)?.Name ?? "sparkonto";
			var amountText = e.Amount.ToString("n2", CultureInfo.GetCultureInfo("sv-SE"));

			_interestBanner = $"Ränta på {amountText} kr lades till på {name}.";

			_ = Task.Run(async () =>
			{
				await Task.Delay(60000);
				_interestBanner = null;
				await InvokeAsync(StateHasChanged);
			});

			await InvokeAsync(StateHasChanged);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Interest update failed: {ex.Message}");
		}
	}

	// Unsubscribes from the InterestApplied event to prevent memory leaks when the page is closed.
	public void Dispose()
	{
		AccountService.InterestApplied -= OnInterestApplied;
	}
}