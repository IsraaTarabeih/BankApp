@page "/transactions/history"
@page "/transactions/history/{AccountId:guid}"
@inject IAccountService AccountService

<h3>Transaktionshistorik</h3>

<div>
	<label>Välj konto</label><br />
	<select @bind="FilterAccountId">
		<option value="" selected>Alla</option>
		@foreach (var account in accounts)
		{
			<option value="@account.Id">@account.Name, (@account.AccountType) - Saldo: @account.Balance SEK </option>
		}
	</select>
</div>

<div>
	<label>Typ</label><br />
	<select @bind="FilterType">
		<option value="">Alla</option>
		<option>Insättning</option>
		<option>Uttag</option>
		<option>ÖverföringIn</option>
		<option>ÖverföringUt</option>
	</select>
</div>

<div>
	<label>Från datum</label><br />
	<input type="date" @bind="FromDate" />
</div>

<div>
	<label>Till datum</label><br />
	<input type="date" @bind="ToDate" />
</div>

<table class="table table-striped table-bordered align-middle mt-3" style="width:100%; border-collapse:separate; border-spacing:0 8px;">
	<thead class="table light">
		<tr>
			<th style="padding:10px;">Datum</th>
			<th style="padding:10px;">Typ</th>
			<th style="padding:10px; text-align:right;">Belopp</th>
			<th style="padding:10px; text-align:right;">Saldo efter</th>
			<th style="padding:10px;">Meddelande</th>
		</tr>
	</thead>
	<tbody>
		@foreach (var transaction in filtered) 
		{
			
			var counter = accounts.FirstOrDefault(account => account.Id == transaction.CounterpartyAccountId);

			var typeText = transaction.Type switch
			{
				TransactionType.Insättning => "Insättning",
				TransactionType.Uttag => "Uttag",
				TransactionType.ÖverföringIn => $"Överföring från {counter?.Name ?? "Okänt konto"}",
				TransactionType.ÖverföringUt => $"Överföring till {counter?.Name ?? "Okänt konto"}",
				_ => transaction.Type.ToString()
			};

			<tr>
				<td style="padding:10px;">@transaction.Date.ToString("yyyy-MM-dd HH:mm", CultureInfo.GetCultureInfo("sv-SE"))</td>
				<td style="padding:10px;">@typeText</td>
				<td style="padding:10px; text-align:right; color:@(transaction.Type == TransactionType.Uttag || transaction.Type == TransactionType.ÖverföringUt ? "red" : "black" )"> 
					@((transaction.Type == TransactionType.Uttag || transaction.Type == TransactionType.ÖverföringUt ? "-" : "") + transaction.Amount.ToString("N0", CultureInfo.GetCultureInfo("sv-SE"))) </td>
				<td style="padding:10px; text-align:right;">@transaction.BalanceAfter.ToString("N0", CultureInfo.GetCultureInfo("sv-SE"))</td>
				<td style="padding:10px;">@transaction.Note</td>
			</tr>
		}
	</tbody>
</table>

@code {
	private List<IBankAccount> accounts = new();
	private List<Transaction> all = new();
	private List<Transaction> filtered = new();
	private string filterAccountId = string.Empty;
	private string filterType = string.Empty;
	private DateTime? fromDate;
	private DateTime? toDate;

	[Parameter] public Guid? AccountId { get; set;}

	protected override async Task OnInitializedAsync()
	{
		accounts = await AccountService.GetAccountsAsync();
		all = await AccountService.GetTransactionsAsync();
		ApplyFilters();

	}

	protected override void OnParametersSet()
	{
		if (AccountId.HasValue)
		{
			filterAccountId = AccountId.Value.ToString();
			ApplyFilters();
		}
	}

	private void ApplyFilters()
	{
		IEnumerable<Transaction> result = all;

		// Ta bort startsaldo
		result = result.Where(transaction => !string.Equals(transaction.Note, "Startsaldo", StringComparison.OrdinalIgnoreCase));

		// Filtrera på konto (om valt)
		if (!string.IsNullOrWhiteSpace(filterAccountId) && Guid.TryParse(filterAccountId, out var id))
		{

			result = result.Where(transaction => transaction.AccountId == id);
		}

		// Filtrera på kontotyp (om valt)
		if (!string.IsNullOrWhiteSpace(filterType) && Enum.TryParse<TransactionType>(filterType, out var tt))
		{
			result = result.Where(transaction => transaction.Type == tt);
		}

		// Filtrera på datumintervall
		if (fromDate.HasValue)
			result = result.Where(transaction => transaction.Date.Date >= fromDate.Value.Date);

		if (toDate.HasValue)
			result = result.Where(transaction => transaction.Date.Date <= toDate.Value.Date);

		if (string.IsNullOrWhiteSpace(filterAccountId))
		{
			result = result.Where(transaction => transaction.Type != TransactionType.ÖverföringIn);
		}

		filtered = result.OrderByDescending(transaction => transaction.Date).ToList();
		StateHasChanged();
	}

	private string FilterAccountId { get => filterAccountId; set { filterAccountId = value; ApplyFilters(); }}

	private string FilterType { get => filterType; set { filterType = value; ApplyFilters(); }}

	private DateTime? FromDate { get => fromDate; set { fromDate = value; ApplyFilters(); }}

	private DateTime? ToDate { get => toDate; set { toDate = value; ApplyFilters(); }}

}
